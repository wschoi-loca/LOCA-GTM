<script>
  (function () {

    // 앱 구분자 설정
    var browserInfo = navigator.userAgent;
    var isGAAndroid = browserInfo.indexOf('GA_Android') > -1;
    var isGAIOS = browserInfo.indexOf('GA_iOS_WK') > -1;
    var commonGAData = {};

    // 콘솔찍을 도메인 목록을 배열로 정의
    var devDomains = [
      'tlocashop.lottecard.co.kr',
      'dmoweb3.lottecard.co.kr',
      'dmoweb2.lottecard.co.kr',
      'dlocashop.lottecard.co.kr'
    ];

    // 현재 페이지의 도메인이 유효한 도메인 목록에 포함되는지 확인
    var isDevDomain = devDomains.some(function(domain) {
      return window.location.hostname.includes(domain);
    });

    // 앱으로 데이터 전달 함수
    var utils = {
      channelMapping : function (url) {
        var urlMapping = {
          "www.lottecard.co.kr": "PC_WEB",
          "dwww.lottecard.co.kr": "PC_TEST",
          "dwww2.lottecard.co.kr": "PC_TEST",
          "m.lottecard.co.kr": "MO_WEB",
          "dmo2.lottecard.co.kr": "MO_TEST",
          "dars.lottecard.co.kr": "MO_DARS",
          "mweb2.lottecard.co.kr": "APP",
          "mbt.lottecard.co.kr": "APP",
          "app-card.lottecard.co.kr": "APP",
          "thing.lottecard.co.kr": "APP",
          "locashop.lottecard.co.kr": "APP",
          "moweb3.lottecard.co.kr": "APP",
          "dmoweb2.lottecard.co.kr": "APP_TEST",
          "dmbt.lottecard.co.kr": "APP_TEST",
          "m-thing-dev.lottecard.co.kr": "APP_TEST",
          "dlocashop.lottecard.co.kr": "APP_TEST",
          "tlocashop.lottecard.co.kr": "APP_TEST",
          "dmoweb3.lottecard.co.kr": "APP_TEST",
        };
  
        return urlMapping[url] || "APP_undefinedChannel";
      },
      deepCopy: function deepCopy(obj) {
        if (obj === null || typeof obj !== 'object') {
          return obj;
        }

        var copy = Array.isArray(obj) ? [] : {};

        for (var key in obj) {
          if (obj.hasOwnProperty(key)) {
            copy[key] = deepCopy(obj[key]);  // 재귀적으로 복사
          }
        }

        return copy;
      },
      
      // GAHybrid 데이터 전송 함수
      sendGAHybrid_v3: function (object) {
        try {
          var GAData = {};  // 매번 새로운 GAData 객체 생성
          if (object.event_name === 'screen_view') {
            GAData = utils.deepCopy(object);  // 깊은 복사
          } else {
            var eventParams = utils.deepCopy(object.eventParams);  // 새로운 eventParams 객체
            var userProperties = utils.deepCopy(object.userProperties);  // 새로운 userProperties 객체
            GAData = utils.deepCopy(object, {
              screen_name: object.screen_name,
              location: object.location,
              eventParams: eventParams,
              userProperties: userProperties
            });
          }
          console.log('sendGAHybrid_v3');
          console.log(GAData);
          isGAAndroid
            ? window.lotteCardgascriptAndroid.GAHybrid(JSON.stringify(GAData))
            : webkit.messageHandlers.lotteCardgascriptCallbackHandler.postMessage(JSON.stringify(GAData));
        } catch (e) {
          console.log('sendGAHybrid_v3 함수 ERROR');
          console.log(e.message);
        }
      }.bind(utils),

      // 값 정리 및 제한 함수
      removeEmptyElement_v3: function (inputValues) {
        var returnValue = {};
        for (var key in inputValues) {
          var value = inputValues[key];
          if (value !== '' && value !== null && value !== undefined && value !== 'undefined' && value !== 'null') {
            returnValue[key] = value;
          }
        }
        return returnValue;  // 매번 새로운 객체 반환
      }.bind(utils),

      // 스크린뷰 전송 함수
      sendGAPage_v3: function (object) {
        try {
          commonGAData = utils.deepCopy(object);  // 깊은 복사
          if (isGAAndroid || isGAIOS || isDevDomain) {
            object.event_name = 'screen_view';
            window._gtmutils.sendGAHybrid_v3(object);
          } else {
            var webData = utils.deepCopy({
                event: 'loca_page',
                title: object.screen_name,
                location: object.location
              },
              utils.deepCopy(object.userProperties),  // 새로운 userProperties 객체
              utils.deepCopy(object.eventParams)  // 새로운 eventParams 객체
            );
            window.dataLayer4.push(webData);
          }
        } catch (e) {
          console.log('sendGAPage 함수 ERROR');
          console.log(e.message);
          console.log(e.stack)
        }
      }.bind(utils),

      // 스크린뷰 외 이벤트 전송 함수
      sendGAEvent_v3: function (object) {
        try {
          if (isGAAndroid || isGAIOS || isDevDomain) {
            window._gtmutils.sendGAHybrid_v3(utils.deepCopy(object));  // 깊은 복사로 이벤트 데이터 전송
          } else {
            var webData = utils.deepCopy({
                event: 'loca_event',
                event_name: object.event_name,
                title: object.screen_name,
                location: object.location
              },
              utils.deepCopy(object.userProperties),  // 새로운 userProperties 객체
              utils.deepCopy(object.eventParams)  // 새로운 eventParams 객체
            );
            window.dataLayer4.push(webData);
          }
        } catch (e) {
          console.log('sendGAEvent 함수 ERROR');
          console.log(e.message);
          console.log(e.stack)
        }
      }.bind(utils),

      // 전자상거래 이벤트 전송 함수
      sendGAEcommerce_v3: function (eventData, items, transactions) {
        try {
          if (isGAAndroid || isGAIOS || isDevDomain) {
            var appData = utils.deepCopy(eventData);  // 깊은 복사
            utils.deepCopy(appData.eventParams, utils.deepCopy(transactions));  // 깊은 복사
            appData.items = utils.deepCopy(items);  // 깊은 복사된 items 배열
            window._gtmutils.sendGAHybrid_v3(appData);
          } else {
            var webData = utils.deepCopy(
              {
                event: 'loca_ecommerce',
                event_name: eventData.event_name,
                title: eventData.screen_name,
                location: eventData.location,
              },
              utils.deepCopy(eventData.userProperties),  // 새로운 userProperties 객체
              utils.deepCopy(eventData.eventParams)  // 새로운 eventParams 객체
            );
            var ecommerceData = utils.deepCopy({ items: utils.deepCopy(items) }, utils.deepCopy(transactions));
            utils.deepCopy(webData, { ecommerce: ecommerceData });
            window.dataLayer4.push(webData);
          }
        } catch (e) {
          console.log('sendGAEcommerce 함수 ERROR');
          console.log(e.message);
          console.log(e.stack)
        }
      }.bind(utils),

      // Helper function to get and parse dataset gtmBody
      // Helper function to get and parse dataset gtmBody
      getGtmBodyData_v3: function (element, eventType) {
        try {
          if (!element) return null;

          var data = {};
          var isEcommerceEvent = ['view-item-list', 'select-item', 'view-item', 'add-to-cart', 'begin-checkout', 'purchase', 'refund', 'etc'].includes(eventType);

          // Check if the event is an eCommerce event
          if (isEcommerceEvent) {
            if (eventType !== 'etc') {
              // If it is an eCommerce event but not 'etc'
              if (element.dataset.gtmEcommerce) {
                data = JSON.parse(element.dataset.gtmEcommerce);
              }
            } else {
              // Handle 'etc' case where both gtmEcommerce and gtmBody need to be combined
              var ec_element = element.closest('[data-gtm-ecommerce]');
              
              if (ec_element && ec_element.dataset.gtmEcommerce) {
                var ec_data = JSON.parse(ec_element.dataset.gtmEcommerce);
                Object.assign(data, ec_data); // Merge eCommerce data
              }
            }
          } else if (element.dataset.gtmBody) {
            // Handle non-eCommerce events that have gtmBody data
            data = JSON.parse(element.dataset.gtmBody);
          } else {
            data = null;
          }
          return utils.deepCopy(data);  // Return deep copy of the combined data

        } catch (error) {
          dataLayer4.push({
            event: 'error_gtmBody',
            error_message: 'getGtmBodyData: ' + error.message,
            page_path: window.location.pathname
          });
          return null;
        }
      }.bind(utils)
    };

    // Main function to handle different events
  function handleEvent_v3(element, eventType, pageParams) {
    try {
      var userProperties = {};
      if (window._gtm && window._gtm.user) {
        var zero_value = '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
        userProperties.user_id = window._gtm.user.sha512_cno ? window._gtm.user.sha512_cno : zero_value;
        userProperties.up_cd58_mbr_group = userProperties.up_cd58_mbr_group = window._gtm.user.mbrType ? (window._gtm.user.mbrType === "MBR" ? "정회원" : "준회원") : undefined;
      }
      
      if (window.commonGAData.userProperties) {
        var userProperties = window.commonGAData.userProperties
      }
      
      var pageParams = utils.deepCopy(pageParams);  // 새로운 pageParams 객체

      if (!element) return;  // If element is missing, exit function early

      var sectionParams = {};  // 새로운 sectionParams 객체
      var sectionElement = element.closest('[data-gtm-section]');
      if (sectionElement) {
        sectionParams = window._gtmutils.getGtmBodyData_v3(sectionElement) || {};
      }

      var eventParams = {};  // 새로운 eventParams 객체

      var isEcommerceEvent = ['view-item-list', 'select-item', 'view-item', 'add-to-cart', 'begin-checkout', 'purchase', 'refund', 'etc'].includes(eventType);
      var eCommerceParams = {};  // 새로운 eCommerceParams 객체

      if (isEcommerceEvent) {
        var eCommerceElement = element.closest('[data-gtm-' + eventType + ']');
        if (eCommerceElement) {
          eCommerceParams = window._gtmutils.getGtmBodyData_v3(eCommerceElement, eventType);
          if (eventType === 'etc') {
            var bodyElement = element.closest('[data-gtm-body]');
            if (bodyElement) {
              var eventParams = window._gtmutils.getGtmBodyData_v3(bodyElement);
            }
          }
        }
        // Only add items for eCommerce events
        eventParams = utils.deepCopy(eventParams, eCommerceParams, sectionParams, pageParams);
      } else {
        var eventElement = element.closest('[data-gtm-' + eventType + ']');
        if (eventElement) {
          eventParams = window._gtmutils.getGtmBodyData_v3(eventElement) || {};
        }
        eventParams = utils.deepCopy(eventParams, sectionParams, pageParams);  // Non-eCommerce events
      }

      // Here you handle and map the final data
      window._gtmutils.mappingData_v3({
        eventType: eventType,
        screen_name: pageParams.ep_cd77_cur_page_title || 'Unknown Page Title',
        location: pageParams.ep_cd123_cur_page_fullurl || window.location.href,
        userProperties: window._gtmutils.removeEmptyElement_v3(userProperties),
        pageParams: window._gtmutils.removeEmptyElement_v3(pageParams),
        sectionParams: window._gtmutils.removeEmptyElement_v3(sectionParams),
        eventParams: window._gtmutils.removeEmptyElement_v3(eventParams),
        eCommerceParams: isEcommerceEvent ? window._gtmutils.removeEmptyElement_v3(eCommerceParams) : {}
      });
    } catch (e) {
      console.log('handleEvent_v3 함수 ERROR');
      console.log(e.message);
      console.log(e.stack);
    }
  }


    function mappingData_v3(data) {
      var eventType = data.eventType;
      var userProperties = data.userProperties || {};
      var sectionParams = {}; // 명시적으로 초기화
      var eventParams = {}; // 명시적으로 초기화
      var eCommerceParams = data.eCommerceParams || {};
      var pageParams = data.pageParams || {};

      function assignIfExists_v3(target, source, keyMappings) {
        if (!source) return;
        keyMappings.forEach(function (mapping) {
          if (source[mapping.source] !== undefined && source[mapping.source] !== null) {
            target[mapping.target] = source[mapping.source];
            delete source[mapping.source]; // 기존 값 삭제
          }
        });
      }

      // sectionParams 및 eventParams 매핑
      assignIfExists_v3(sectionParams, data.sectionParams, [
        { source: 'label1', target: 'ep_category_depth1' },
        { source: 'label2', target: 'ep_category_depth2' },
        { source: 'label3', target: 'ep_category_depth3' },
        { source: 'index', target: 'ep_section_index' }
      ]);

      
      assignIfExists_v3(eventParams, data.eventParams, [
        { source: 'label', target: 'ep_label_text' },
        { source: 'search_keyword', target: 'ep_cd25_srch_keyword' },
        { source: 'search_type', target: 'ep_srch_keyword_type' },
        { source: 'search_result', target: 'ep_cd26_srch_result' },
        { source: 'search_result_click', target: 'ep_cd27_srch_res_clk_nm' },
        { source: 'card_name', target: 'ep_cd12_card_name' },
        { source: 'card_code', target: 'ep_card_code' },
        { source: 'card_new_or_exist', target: 'ep_cd64_card_apply_code' },
        { source: 'card_type', target: 'ep_cd65_card_apply_kind' },
        { source: 'fin_prod_name', target: 'ep_cd13_fn_pd_nm' },
        { source: 'fin_amount', target: 'ep_cd17_fn_loan_amt' },
        { source: 'revol_rate', target: 'ep_cd19_rvo_egm_stt_rt' },
        { source: 'revol_term', target: 'ep_cd20_rvo_egm_stt_te' },
        { source: 'prod_funnel_name', target: 'ep_cd48_pd_apply_nm' },
        { source: 'cts_name', target: 'ep_cd14_cts_nm' },
        { source: 'cts_id', target: 'ep_cd42_cts_id' },
        { source: 'cts_sub_id', target: 'ep_cd79_sub_cts_id' },
        { source: 'index', target: 'ep_contents_index' }
      ]);

      if(eventType !== 'screen_view') {
        
        var event_name;
        var isPopup = data.sectionParams.is_popup ? 'popup' : 'cts';
        var eventTypeMapped = eventType === 'visibility' ? 'view' : 'click';
        event_name = isPopup + '_' + eventTypeMapped;

        if (Object.keys(eCommerceParams).length > 0) {
          event_name = eventType.replaceAll('-', '_');
        }

        var ep_category;
        if (Object.keys(eCommerceParams).length > 0) {
          ep_category = '띵샵_이커머스';
        } else {
          var category = eventParams.ep_cd14_cts_nm || eventParams.ep_label_text || eventParams.ep_category_depth1 || 'n';
          ep_category = '콘텐츠_' + category + '_메인_' + pageParams.ep_cd15_page_depth1;
        }

        var ep_action = eventType === 'visibility' ? '노출' : '클릭';
        if (Object.keys(eCommerceParams).length > 0) {
          var eCommerceClicks = ['select_item', 'add_to_cart', 'etc'];
          ep_action = eCommerceClicks.includes(event_name) ? '클릭' : '노출';
        }

        var ep_label
        if (Object.keys(eCommerceParams).length > 0) {
          ep_label = eventParams.ep_cd14_cts_nm || eventParams.ep_label_text || eventParams.ep_category_depth1 || 'n';
        } else {
          var id = eventParams.ep_cd14_cts_nm || 'n';
          var sid = eventParams.ep_cd79_sub_cts_id || 'n';
          var or1 = eventParams.ep_section_index || 'n';
          var or2 = eventParams.ep_contents_index || 'n';
          var de = eventParams.ep_cd14_cts_nm || eventParams.ep_label_text || 'n';
          var clk = eventParams.ep_label_text || 'n';
      
          ep_label = eventType === 'visibility' 
            ? 'id:' + id + '_sid:' + sid + '_or1:' + or1 + '_or2:' + or2 + '_de:' + de
            : 'id:' + id + '_sid:' + sid + '_or1:' + or1 + '_or2:' + or2 + '_de:' + de + '_clk:' + clk;
        }

        if (window._gtm && window._gtm.user) {
          var zero_value = '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
          var sha512_cno =  window._gtm.user && window._gtm.user.sha512_cno ? window._gtm.user.sha512_cno : zero_value;
          var first100Chars = sha512_cno.substring(0, 100);
          var remainingChars = sha512_cno.substring(100);
          var ga_channel = utils.channelMapping({{Page Hostname}}); // 채널 매핑 함수 호출

          eventParams.ep_cd10_channel_type = ga_channel;

          eventParams.ep_cd54_lgn_session_id1 = first100Chars;
          eventParams.ep_cd55_lgn_session_id2 = remainingChars + '|' + ga_channel +'|' + {{VAR_JS_dimension49 (Time Stamp)}};

          eventParams.ep_cd120_user_id1 = first100Chars;
          eventParams.ep_cd121_user_id2 = remainingChars;
          eventParams.ep_cd4_lgn_yn = window._gtm.isLogin ? "1" : "U";    
          eventParams.ep_cd5_lgn_type = window._gtm.user.lgnType ? window._gtm.user.lgnType : undefined;     
          eventParams.ep_cd122_lgn_dtti = window._gtm.user.lgnDtti ? window._gtm.user.lgnDtti : undefined;
          eventParams.ep_cd49_timestamp = {{VAR_JS_dimension49 (Time Stamp)}} ? {{VAR_JS_dimension49 (Time Stamp)}} : undefined;
        }
      
        
       // 새 객체를 만들어서 복사된 값과 추가 속성을 결합
        var eventParams = Object.assign({}, eventParams, sectionParams, pageParams, {
          ep_category: ep_category,
          ep_action: ep_action,
          ep_label: ep_label
        });
      }

      var gaFinalData = {
        event_name: event_name,
        screen_name: data.screen_name,
        location: data.location,
        eventParams: eventParams,
        userProperties: userProperties
      };

      if (Object.keys(eCommerceParams).length > 0) {
        var items = eCommerceParams.ecommerce ? eCommerceParams.ecommerce.items : [];
        var transactions = window._gtmutils.removeEmptyElement_v3(eCommerceParams.ecommerce || {});
        window._gtmutils.sendGAEcommerce_v3(gaFinalData, items, transactions);
      } else {
        window._gtmutils.sendGAEvent_v3(gaFinalData);
      }
    }

    window._gtmutils = {
      sendGAHybrid_v3: utils.sendGAHybrid_v3,
      getGtmBodyData_v3: utils.getGtmBodyData_v3,
      removeEmptyElement_v3: utils.removeEmptyElement_v3,
      sendGAPage_v3: utils.sendGAPage_v3,
      sendGAEvent_v3: utils.sendGAEvent_v3,
      sendGAEcommerce_v3: utils.sendGAEcommerce_v3,
      handleEvent_v3: handleEvent_v3,
      mappingData_v3: mappingData_v3,
      deepCopy: utils.deepCopy,
      channelMapping: utils.channelMapping
    };
  })();
</script>
